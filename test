---
- name: Test directory creation and file copying
  hosts: prccnonprodservers
  remote_user: afernandez
  become_method: sudo
  become: yes
  vars:
    dest_base_path: "/tmp/html-report"
    src_path: "/tmp/server_info"

  tasks:
    - name: Debug base directory path
      debug:
        msg: "Base directory path is {{ dest_base_path }}"

    - name: Ensure base destination directory exists
      file:
        path: "{{ dest_base_path }}"
        state: directory
        mode: '0775'
      become: yes

    - name: Set current date
      set_fact:
        current_date: "{{ lookup('pipe', 'date +%Y-%m-%d') }}"

    - name: Debug current date
      debug:
        msg: "Current date is {{ current_date }}"

    - name: Create directory with the current date
      file:
        path: "{{ dest_base_path }}/{{ current_date }}"
        state: directory
        mode: '0775'
      become: yes

    - name: Debug directory creation
      stat:
        path: "{{ dest_base_path }}/{{ current_date }}"
      register: directory_status

    - name: Show directory status
      debug:
        var: directory_status

    - name: Create a sample HTML file
      shell: |
        echo "<h1>Test HTML File</h1>" > /tmp/server_info/test.html
      become: yes

    - name: Copy HTML file to the directory with the current date
      copy:
        src: "{{ src_path }}/test.html"
        dest: "{{ dest_base_path }}/{{ current_date }}/"
        mode: '0775'
        remote_src: yes
      become: yes

    - name: Debug file copy
      stat:
        path: "{{ dest_base_path }}/{{ current_date }}/test.html"
      register: file_status

    - name: Show file status
      debug:
        var: file_status
